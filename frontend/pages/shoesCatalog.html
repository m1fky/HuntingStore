<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог товаров | Hunting Store</title>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous" async></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous" defer></script>

    <link href="../styles/cartStyle.css" rel="stylesheet" crossorigin="anonymous">

    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" href="../favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="manifest" href="../favicon/site.webmanifest">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            margin-top: 20px;
        }

        .filter-sidebar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }

        .filter-sidebar h4 {
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .form-select, .form-range {
            margin-bottom: 15px;
        }

        .filter-sidebar button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
        }

        .filter-sidebar button:hover {
            background-color: #218838;
        }

        .product-card {
            border: none;
            transition: transform 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: scale(1.05);
        }

        .product-card img {
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-card .card-body {
            text-align: center;
        }

        .btn-buy {
            width: 100%;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
            padding: 10px;
        }

        .btn-buy:hover {
            background-color: #218838;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .card-text {
            font-size: 14px;
            color: #888;
        }

        .price-range {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
    </style>
</head>
<body>
<header>
    <div class="logo_div">
        <a href="../index.html" class="logo_href">
            <div class="logo_href">
                <img class="img_logo" src="../vendor/Магазин_лого.png" alt="Hunting Store" title="Hunting Store">
                <span class="name_logo">Hunting Store</span>
            </div>
        </a>
    </div>
    <nav>
        <ul>
            <button class="auth-button"><li><a href="../index.html">Каталог</a></li></button>
            <button id="auth-button" class="auth-button" onclick="openFormContainer()"><li><span class="a">Регистрация/Авторизация</span></li></button>
            <button class="auth-button" onclick="lk_and_cart_check()"><li><a class="cookie-required" href="./cart.html">Корзина</a></li></button>
            <button class="auth-button" onclick="lk_and_cart_check()"><li><a class="cookie-required" href="./profile.html">Личный кабинет</a></li></button>
            <button id="logout-button" class="auth-button" style="display: none;"><li><a href="">Выйти</a></li></button>
            <button class="auth-button"><li><a href="./about.html">О магазине</a></li></button>
        </ul>
    </nav>
</header>

<h1>Обувь</h1>

<div class="container">
    <div class="row">
        <aside class="col-md-3 filter-sidebar">
            <h4>Фильтры</h4>

            <div>
                <label for="priceRange" class="filter-label">Цена:</label>
                <input type="range" class="form-range" id="priceRange" min="1000" max="150000" step="500">
                <div class="price-range">
                    <span id="priceMin">1000 ₽</span>
                    <span id="priceValue">150000 ₽</span>
                </div>
            </div>

            <div>
                <label for="categorySelect" class="filter-label">Категория:</label>
                <select class="form-select" id="categorySelect">
                    <option value="all">Все</option>
                    <option value="guns">Охотничье оружие</option>
                    <option value="boots">Ботинки</option>
                    <option value="suits">Комбинезоны</option>
                </select>
            </div>

            <div>
                <label for="sortSelect" class="filter-label">Сортировать по:</label>
                <select class="form-select" id="sortSelect">
                    <option value="price_asc">Цене (возрастанию)</option>
                    <option value="price_desc">Цене (убыванию)</option>
                </select>
            </div>
            <button id="applyFilters">Применить фильтры</button>
        </aside>

        <section class="col-md-9">
            <div class="row" id="productContainer"></div>
        </section>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        loadProducts(); // Загружаем товары при загрузке страницы

        // Обработчики событий
        document.getElementById("priceRange").addEventListener("input", () => {
            document.getElementById("priceValue").textContent = document.getElementById("priceRange").value + " ₽";
            applyFilters(); // Применяем фильтры сразу при изменении ползунка
        });

        document.getElementById("applyFilters").addEventListener("click", applyFilters);
        document.getElementById("categorySelect").addEventListener("change", applyFilters);
        document.getElementById("sortSelect").addEventListener("change", applyFilters);
    });

    // Глобальная переменная для хранения всех товаров
    let allProducts = [];

    // Функция для загрузки всех товаров с сервера
    async function loadProducts() {
        try {
            let response = await fetch(`https://check-j52a.onrender.com/products`);
            allProducts = await response.json();
            
            // Находим максимальную цену для настройки ползунка
            let maxPrice = Math.max(...allProducts.map(p => p.price));
            if (maxPrice > 0) {
                document.getElementById("priceRange").max = maxPrice;
                document.getElementById("priceRange").value = maxPrice;
                document.getElementById("priceValue").textContent = maxPrice + " ₽";
            }
            
            applyFilters(); // Применяем фильтры после загрузки
        } catch (error) {
            console.error("Ошибка загрузки товаров:", error);
        }
    }

    // Функция применения фильтров
    function applyFilters() {
        if (!allProducts.length) return;
        
        let maxPrice = parseInt(document.getElementById("priceRange").value);
        let category = document.getElementById("categorySelect").value;
        let sort = document.getElementById("sortSelect").value;

        // Фильтрация товаров
        let filteredProducts = allProducts.filter(product => {
            // Фильтр по цене
            const priceMatch = product.price <= maxPrice;
            
            // Фильтр по категории
            const categoryMatch = category === 'all' || product.category === category;
            
            return priceMatch && categoryMatch;
        });

        // Сортировка товаров
        filteredProducts = sortProducts(filteredProducts, sort);
        
        // Отображение товаров
        renderProducts(filteredProducts);
    }

    // Функция для сортировки товаров (без изменений)
    function sortProducts(products, sortOption) {
        const sortedProducts = [...products];
        
        if (sortOption === 'price_asc') {
            return sortedProducts.sort((a, b) => a.price - b.price);
        } else if (sortOption === 'price_desc') {
            return sortedProducts.sort((a, b) => b.price - a.price);
        }
        return sortedProducts;
    }

    // Функция для отображения товаров на странице (без изменений)
    function renderProducts(products) {
        let productContainer = document.getElementById("productContainer");
        productContainer.innerHTML = "";

        if (products.length === 0) {
            productContainer.innerHTML = '<div class="col-12 text-center"><p>Товары не найдены</p></div>';
            return;
        }

        products.forEach(product => {
            let productImage = product.image || "https://via.placeholder.com/250x250?text=Product";
            let productHTML = `
                <div class="col-lg-4 col-md-6 mb-4 product">
                    <div class="card product-card">
                        <img src="${productImage}" class="card-img-top" alt="${product.name}">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">Цена: ${product.price} ₽</p>
                            <button class="btn btn-buy">Купить</button>
                        </div>
                    </div>
                </div>
            `;
            productContainer.innerHTML += productHTML;
        });
    }
</script>
</body>
</html>